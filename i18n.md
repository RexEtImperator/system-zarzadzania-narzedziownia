# Międzynarodowość (i18n)

Dokument opisuje architekturę tłumaczeń, przepływ danych, walidacje, skrypty utrzymaniowe oraz dobre praktyki.

## Przegląd
- Języki interfejsu: `pl`, `en`, `de`.
- Źródła tłumaczeń:
  - Pliki bazowe: `src/i18n/pl.json`, `src/i18n/en.json`, `src/i18n/de.json`.
  - Nadpisania (override) w DB: tabela `translate` (priorytet nad plikami).
- Kontekst języka dostarcza funkcję `t(key, params)` oraz obsługę zmiany języka.

## Frontend
- Kontekst i funkcja tłumaczeń:
  - `LanguageContext` ładuje nadpisania z backendu i stosuje je w `t()`.
  - Implementacja: `src/contexts/LanguageContext.jsx:93–107`, `src/contexts/LanguageContext.jsx:117–128`.
- Interpolacja parametrów:
  - Funkcja `interpolate` zastępuje placeholdery `{param}` wartościami z `params`.
  - Ostrzega przy brakujących parametrach lub wywołaniu bez `params` dla szablonu z placeholderami.
  - Implementacja: `src/contexts/LanguageContext.jsx:13–31`.
- Rozwiązywanie kluczy (kropkowe nazwy):
  - `resolveKey` pozwala na dostęp do zagnieżdżonych kluczy przez notację kropkową.
  - Implementacja: `src/contexts/LanguageContext.jsx:33–45`.

### Priorytet wartości
- `DB override` ma pierwszeństwo przed wartością z pliku.
- Logika wyboru wartości w `t()`:
  - Sprawdzenie czy istnieje override i czy ma niepustą wartość.
  - W przeciwnym razie użycie wartości z pliku.
- Implementacja: `src/contexts/LanguageContext.jsx:117–128`.

## Backend
- Tabela `translate` (nadpisania kluczy):
  - Tworzenie tabeli i seed z plików i18n przy pierwszym uruchomieniu.
  - Implementacja: `server.js:1134–1148`, `server.js:1175–1213`.
- Endpointy:
  - `GET /api/translations/:lang` — mapa tłumaczeń `{ translations: { key: value } }` dla danego języka.
    - Implementacja: `server.js:4402–4406`.
  - `GET /api/translate` — administracyjny widok/filtrowanie (wymaga `SYSTEM_SETTINGS`).
    - Implementacja: `server.js:4417–4425`.
  - `PUT /api/translate/bulk` — administracyjny bulk update (wymaga `SYSTEM_SETTINGS`).
    - Implementacja: `server.js:4439–4447`.

## Walidacja brakujących kluczy
- Test skanujący wywołania `t('...')` w kodzie i sprawdzający obecność klucza w plikach lub DB:
  - Plik: `src/__tests__/i18nKeys.test.js:1–108`.
  - Tryb domyślny: wypisuje ostrzeżenie (nie przerywa testów).
  - Tryb strict (failuje test): ustaw zmienną środowiskową `I18N_STRICT=true`.

### Uruchamianie testów
```
npm test -- --watchAll=false
```
- Tryb strict:
```
set I18N_STRICT=true && npm test -- --watchAll=false
```

## Skrypty utrzymaniowe
- Raport różnic między plikami i DB:
```
npm run i18n:diff
```
  - Implementacja: `scripts/report_translation_diff.js:65–113`.
- Synchronizacja plików → DB (upsert z priorytetem DB podczas pracy aplikacji):
```
npm run i18n:sync
```
  - Implementacja: `scripts/sync_translations_from_files.js:28–75`.

## Konwencje i dobre praktyki
- Nazewnictwo kluczy: notacja kropkowa (np. `scanner.errors.permissionDenied`).
- Interpolacja: używaj `{count}`, `{name}` itp. (unikaj wstrzyknięć HTML; wartości interpolowane traktowane jako tekst).
- Dodawanie nowych kluczy:
  - Dodaj do wszystkich plików językowych (`pl/en/de`), nawet jeśli część wartości jest tymczasowo kopiowana.
  - Jeśli klucz ma być nadpisywany z DB, nadal dodaj go do plików bazowych (ułatwia spójność i raporty).
- Pluralizacja i formaty dat:
  - Używaj utili z `src/utils/dateUtils.js` (lokalizacja formatu i komunikatów czasu względnego dla PL/EN/DE).

## Przepływ pracy (workflow)
1. Dodaj/zmień klucze w `src/i18n/*.json`.
2. Uruchom `npm run i18n:diff` i przejrzyj różnice (braki/rozbieżności).
3. Zsynchronizuj pliki do DB: `npm run i18n:sync`.
4. W UI (AppConfig → zakładka „Translation”) edytuj wartości dla wybranego języka; zapis wyśle tylko zmienione pary `key|lang`.
5. Uruchom testy `npm test` (opcjonalnie w trybie strict): upewnij się, że wszystkie klucze `t('...')` mają wartości.

## Rozwiązywanie problemów
- Brakujące parametry interpolacji:
  - Konsola pokaże ostrzeżenie z listą placeholderów i szablonem, np. `console.warn('Missing interpolation params', { missing, template })`.
- Braki kluczy w raporcie/testach:
  - Dodaj brakujące klucze w plikach lub wprowadź nadpisania w DB.
- Konflikt wartości DB vs plik:
  - `t()` preferuje wartość z DB, jeśli niepusta i różna od klucza.

## Odnośniki do kodu
- `LanguageContext`: `src/contexts/LanguageContext.jsx:93–107`, `src/contexts/LanguageContext.jsx:117–128`.
- `interpolate`: `src/contexts/LanguageContext.jsx:13–31`.
- Seed i tabela `translate`: `server.js:1134–1148`, `server.js:1175–1213`.
- Endpointy i18n: `server.js:4402–4406`, `server.js:4417–4425`, `server.js:4439–4447`.
- Test walidacji kluczy: `src/__tests__/i18nKeys.test.js:1–108`.
- Raport różnic: `scripts/report_translation_diff.js:65–113`.
- Synchronizacja: `scripts/sync_translations_from_files.js:28–75`.